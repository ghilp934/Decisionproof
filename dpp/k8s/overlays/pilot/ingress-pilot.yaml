# ingress-pilot.yaml
# Strategic Merge Patch: ingress.yaml의 Ingress 리소스를 pilot 전용으로 완전 교체
#
# 설계 결정:
#   - metadata.annotations: 키 단위 MERGE (patch 값이 base 값을 덮어씀)
#     → us-east-1 / ${CERTIFICATE_ID} / ${ALB_SECURITY_GROUP_ID} 토큰 제거
#   - spec: $patch:replace → base의 host:api.example.com 규칙이 섞이지 않도록
#     pilot hosts 전체를 SYNC_MARKER 구간으로 관리
#
# ⚠️ 이 파일의 spec.rules 구간을 직접 편집하지 마세요.
#   pilot.params.yaml의 PILOT_HOST / PILOT_HOST_ALIASES 수정
#   → ./sync_pilot_values.sh 실행 → BEGIN/END 마커 구간이 자동 치환됩니다.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dpp-api-ingress
  namespace: dpp-pilot
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/backend-protocol: HTTP
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/healthcheck-path: /readyz

    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:783268398937:certificate/8b0225d0-8ff7-40ea-80fb-2b11167ca77c
    alb.ingress.kubernetes.io/security-groups: sg-09caf889f951e4d02
    # custom SG(security-groups) 지정 시 ALB Controller가 백엔드 SG 규칙도 직접 관리하도록 필수
    alb.ingress.kubernetes.io/manage-backend-security-group-rules: "true"

    alb.ingress.kubernetes.io/tags: Environment=pilot,Application=dpp-api,Version=0.4.2.2
spec:
  $patch: replace
  rules:
  # BEGIN:SYNC_HOST_RULES — sync_pilot_values.sh 가 이 구간을 완전 치환합니다. 직접 편집 금지.
  - host: api-pilot.decisionproof.io.kr
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dpp-api
            port:
              number: 80
  - host: api.decisionproof.io.kr
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dpp-api
            port:
              number: 80
  # END:SYNC_HOST_RULES
