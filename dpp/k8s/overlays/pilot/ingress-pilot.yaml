# ingress-pilot.yaml
# Strategic Merge Patch: Ingress annotations을 pilot 전용으로 교체
#
# 설계 결정:
#   - metadata.annotations: 키 단위 MERGE (patch 값이 base 값을 덮어씀)
#     → us-east-1 / ${CERTIFICATE_ID} / ${ALB_SECURITY_GROUP_ID} 토큰 제거
#   - spec.rules: patch-ingress-rules-pilot.yaml (JSON 6902)에서 별도 관리
#     → $patch:replace SMP 방식이 kustomize 버전에 따라 $patch:null 버그를 일으켜
#       JSON 6902 패치 파일로 분리함
#
# ⚠️ spec.rules 는 patch-ingress-rules-pilot.yaml에서 관리합니다.
#   pilot.params.yaml의 PILOT_HOST / PILOT_HOST_ALIASES 수정
#   → ./sync_pilot_values.sh 실행 → patch-ingress-rules-pilot.yaml의 BEGIN/END 마커 구간 자동 치환
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dpp-api-ingress
  namespace: dpp-pilot
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/backend-protocol: HTTP
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/healthcheck-path: /readyz

    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:783268398937:certificate/8b0225d0-8ff7-40ea-80fb-2b11167ca77c
    alb.ingress.kubernetes.io/security-groups: sg-09caf889f951e4d02
    # custom SG(security-groups) 지정 시 ALB Controller가 백엔드 SG 규칙도 직접 관리하도록 필수
    alb.ingress.kubernetes.io/manage-backend-security-group-rules: "true"

    alb.ingress.kubernetes.io/tags: Environment=pilot,Application=dpp-api,Version=0.4.2.2
